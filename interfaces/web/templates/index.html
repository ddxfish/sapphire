<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sapphire</title>
    <link rel="stylesheet" href="/static/shared.css">
    
    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4a9eff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sapphire">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

    <script>
        // Load saved theme before CSS renders to prevent flash
        (function() {
            const saved = localStorage.getItem('sapphire-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            // Load theme CSS file
            const link = document.createElement('link');
            link.id = 'theme-stylesheet';
            link.rel = 'stylesheet';
            link.href = '/static/themes/' + saved + '.css';
            document.head.appendChild(link);
        })();
    </script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <button id="toggle-sidebar" title="Toggle Sidebar">â˜°</button>
    
    <div class="sidebar">
        <!-- Row 1: Title + App Menu -->
        <div class="sidebar-row-1">
            <h1>Sapphire</h1>
            <div class="header-actions">
                <div class="kebab-menu" id="app-menu">
                    <button class="kebab-btn" title="App Menu">âš™ï¸</button>
                    <div class="kebab-dropdown">
                        <div id="plugin-icon-area"></div>
                        <button id="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Chat selector + Chat Menu -->
        <div class="sidebar-row-2">
            <select id="chat-select">
                <option value="default">Default</option>
            </select>
            <div class="kebab-menu" id="chat-menu">
                <button class="kebab-btn" title="Chat Menu">â‹®</button>
                <div class="kebab-dropdown">
                    <button id="new-chat-btn">New Chat</button>
                    <button id="clear-chat-btn">Clear Chat</button>
                    <button id="delete-chat-btn" class="danger">Delete Chat</button>
                    <hr>
                    <button id="import-chat-btn">Import</button>
                    <button id="export-chat-btn">Export</button>
                    <hr>
                    <button id="settings-gear-btn">Chat Settings</button>
                </div>
            </div>
        </div>

        <!-- Row 3: Volume controls -->
        <div class="sidebar-row-3">
            <button id="mute-btn" title="Mute/Unmute">ğŸ”Š</button>
            <input type="range" id="volume-slider" min="0" max="100" value="100" title="Volume">
        </div>

        <div class="plugin-container" id="sidebar-plugin-area"></div>
    </div>

    <div class="main">
        <div id="chatbg">
            <div id="chatbg-overlay">
                <div id="chat-container"></div>
            </div>
        </div>
        <div class="form-wrapper">
            <form id="chat-form">
                <button type="button" id="mic-btn" title="Hold to record">ğŸ¤</button>
                <div class="textarea-wrapper">
                    <textarea id="prompt-input" placeholder="Type message..." rows="1"></textarea>
                </div>
                <button type="submit" id="send-btn">Send</button>
                <button type="button" id="stop-btn" style="display: none;">Stop</button>
            </form>
            <div class="pill-bar">
                <button class="pill" id="prompt-pill">
                    <span class="pill-icon">âœï¸</span>
                    <span class="pill-text">Loading...</span>
                    <span class="pill-tooltip"></span>
                    <div class="pill-dropdown"></div>
                </button>
                <button class="pill" id="ability-pill">
                    <span class="pill-icon">ğŸ”§</span>
                    <span class="pill-text">Loading...</span>
                    <span class="pill-tooltip"></span>
                    <div class="pill-dropdown"></div>
                </button>
            </div>
            <div id="prompt-display"></div>
            <div id="functions-display"></div>
        </div>
        <div id="toast-container"></div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".json" style="display:none">

    <!-- Settings Modal (uses shared modal pattern) -->
    <div id="settings-modal" class="modal-overlay" style="display: none">
        <div class="modal-base">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <button class="close-btn" id="cancel-settings">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-grid">
                    <div class="form-group">
                        <label for="setting-prompt">Prompt:</label>
                        <select id="setting-prompt" class="form-control">
                            <option value="sapphire">Sapphire (Default)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-ability">Ability Set:</label>
                        <select id="setting-ability" class="form-control">
                            <option value="default">Default</option>
                            <option value="none">None</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="setting-voice">Voice:</label>
                        <select id="setting-voice" class="form-control">
                            <option value="am_adam">ğŸ‡ºğŸ‡¸ğŸ‘¨ Adam</option>
                            <option value="am_eric">ğŸ‡ºğŸ‡¸ğŸ‘¨ Eric</option>
                            <option value="am_liam">ğŸ‡ºğŸ‡¸ğŸ‘¨ Liam</option>
                            <option value="am_michael">ğŸ‡ºğŸ‡¸ğŸ‘¨ Michael</option>
                            <option value="am_onyx">ğŸ‡ºğŸ‡¸ğŸ‘¨ Onyx</option>
                            <option value="am_santa">ğŸ‡ºğŸ‡¸ğŸ‘¨ Santa</option>
                            <option value="af_bella">ğŸ‡ºğŸ‡¸ğŸ‘© Bella</option>
                            <option value="af_nicole">ğŸ‡ºğŸ‡¸ğŸ‘© Nicole</option>
                            <option value="af_heart">ğŸ‡ºğŸ‡¸ğŸ‘© Heart</option>
                            <option value="af_jessica">ğŸ‡ºğŸ‡¸ğŸ‘© Jessica</option>
                            <option value="af_sarah">ğŸ‡ºğŸ‡¸ğŸ‘© Sarah</option>
                            <option value="af_river">ğŸ‡ºğŸ‡¸ğŸ‘© River</option>
                            <option value="af_sky">ğŸ‡ºğŸ‡¸ğŸ‘© Sky</option>
                            <option value="bf_emma">ğŸ‡¬ğŸ‡§ğŸ‘© Emma</option>
                            <option value="bf_isabella">ğŸ‡¬ğŸ‡§ğŸ‘© Isabella</option>
                            <option value="bf_alice">ğŸ‡¬ğŸ‡§ğŸ‘© Alice</option>
                            <option value="bf_lily">ğŸ‡¬ğŸ‡§ğŸ‘© Lily</option>
                            <option value="bm_george">ğŸ‡¬ğŸ‡§ğŸ‘¨ George</option>
                            <option value="bm_daniel">ğŸ‡¬ğŸ‡§ğŸ‘¨ Daniel</option>
                            <option value="bm_lewis">ğŸ‡¬ğŸ‡§ğŸ‘¨ Lewis</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-pitch">Pitch: <span id="pitch-value">0.94</span></label>
                        <input type="range" id="setting-pitch" class="form-control" min="0.5" max="1.5" step="0.02" value="0.94">
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-speed">Speed: <span id="speed-value">1.3</span></label>
                        <input type="range" id="setting-speed" class="form-control" min="0.5" max="2.5" step="0.1" value="1.3">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting-spice" checked>
                            Spice every <input type="number" id="setting-spice-turns" min="1" max="20" value="3" style="width: 3em;"> turns
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="setting-datetime">
                            Inject Date/Time
                        </label>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="setting-custom-context">Custom Context:</label>
                        <textarea id="setting-custom-context" class="form-control" rows="3" placeholder="Custom text injected into system prompt..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="save-as-defaults" class="btn btn-secondary" title="Save current settings as default for new chats">Set as Default</button>
                <div style="flex: 1;"></div>
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-settings" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>


    <template id="message-template">
        <div class="message">
            <img src="" alt="Avatar" class="msg-avatar">
            <div class="message-wrapper">
                <div class="message-content"></div>
                <div class="toolbar"></div>
            </div>
        </div>
    </template>

    <template id="status-template">
        <div class="message status" id="status-message">
            <img src="/static/users/assistant.png" alt="Avatar" class="msg-avatar" onerror="this.style.display='none'">
            <div class="message-content">
                <div class="spinner"></div>
                <span class="status-text">Thinking...</span>
            </div>
        </div>
    </template>

    <script type="module" src="/static/main.js"></script>
</body>
</html>