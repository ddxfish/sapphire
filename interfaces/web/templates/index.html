<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Sapphire</title>
    <link rel="stylesheet" href="/static/shared.css">
    
    <!-- Syntax Highlighting (local) -->
    <link rel="stylesheet" href="/static/vendor/highlight-atom-one-dark.min.css">
    <script src="/static/vendor/highlight.min.js"></script>
    
    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4a9eff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sapphire">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

    <script>
        // Load saved theme before CSS renders to prevent flash
        (function() {
            const saved = localStorage.getItem('sapphire-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            // Load theme CSS file
            const link = document.createElement('link');
            link.id = 'theme-stylesheet';
            link.rel = 'stylesheet';
            link.href = '/static/themes/' + saved + '.css';
            document.head.appendChild(link);
        })();
    </script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="sidebar-collapsed">
    <button id="toggle-sidebar" title="Toggle Sidebar">â€º</button>
    
    <div class="sidebar">
        <!-- Row 1: Title + App Menu -->
        <div class="sidebar-row-1">
            <h1>Sapphire</h1>
            <div class="header-actions">
                <div class="kebab-menu" id="app-menu">
                    <button class="kebab-btn" title="App Menu">âš™ï¸</button>
                    <div class="kebab-dropdown">
                        <div id="plugin-icon-area"></div>
                        <button id="setup-wizard-btn">Setup Wizard</button>
                        <button id="restart-btn">Restart Sapphire</button>
                        <button id="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Chat selector + Chat Menu -->
        <div class="sidebar-row-2">
            <select id="chat-select">
                <option value="default">Default</option>
            </select>
            <div class="kebab-menu" id="chat-menu">
                <button class="kebab-btn" title="Chat Menu">â‹®</button>
                <div class="kebab-dropdown">
                    <button id="new-chat-btn">New Chat</button>
                    <button id="clear-chat-btn">Clear Chat</button>
                    <button id="delete-chat-btn" class="danger">Delete Chat</button>
                    <hr>
                    <button id="import-chat-btn">Import</button>
                    <button id="export-chat-btn">Export</button>
                    <hr>
                    <button id="settings-gear-btn">Chat Settings</button>
                </div>
            </div>
        </div>

        <!-- Row 3: Volume controls -->
        <div class="sidebar-row-3">
            <button id="mute-btn" title="Mute/Unmute">ğŸ”Š</button>
            <input type="range" id="volume-slider" min="0" max="100" value="100" title="Volume">
        </div>

        <div class="plugin-container" id="sidebar-plugin-area"></div>
    </div>

    <div class="main">
        <div id="chatbg">
            <div id="chatbg-overlay">
                <div id="chat-container"></div>
            </div>
        </div>
        <div class="form-wrapper">
            <div id="context-bar"></div>
            <div id="image-preview-area" style="display: none;"></div>
            <form id="chat-form">
                <button type="button" id="mic-btn" title="Hold to record">ğŸ¤</button>
                <div class="textarea-wrapper">
                    <button type="button" id="image-upload-btn" title="Attach image (or paste/drop)">ğŸ“</button>
                    <textarea id="prompt-input" placeholder="Type message... (paste or drop images)" rows="1"></textarea>
                </div>
                <input type="file" id="image-upload-input" accept="image/*,.py,.txt,.md,.js,.ts,.json,.yaml,.yml,.toml,.ini,.cfg,.conf,.sh,.bash,.html,.css,.xml,.csv,.log,.env,.rs,.go,.java,.c,.cpp,.h" multiple style="display: none;">
                <div class="send-btn-wrapper">
                    <button type="submit" id="send-btn">Send</button>
                    <button type="button" id="stop-btn" style="display: none;">Stop</button>
                    <span id="llm-indicator"></span>
                </div>
            </form>
            <div class="pill-bar">
                <button class="spice-indicator" id="spice-indicator" title="Spice disabled">
                    <span class="spice-icon">ğŸŒ¶ï¸</span>
                    <span class="spice-tooltip"></span>
                </button>
                <button class="pill" id="prompt-pill">
                    <span class="pill-icon">âœï¸</span>
                    <span class="pill-text">Loading...</span>
                    <span class="pill-tooltip"></span>
                    <div class="pill-dropdown"></div>
                </button>
                <button class="pill" id="ability-pill">
                    <span class="pill-icon">ğŸ”§</span>
                    <span class="pill-text">Loading...</span>
                    <span class="pill-tooltip"></span>
                    <div class="pill-dropdown"></div>
                </button>
                <div class="story-menu" id="story-indicator">
                    <button class="story-btn" title="Story Engine">
                        <span class="story-icon">ğŸ“–</span>
                    </button>
                    <span class="story-tooltip"></span>
                    <div class="story-dropdown">
                        <div class="story-dropdown-header has-submenu">
                            <span class="story-dropdown-header-text"></span>
                            <span class="story-dropdown-arrow">â€º</span>
                            <div class="story-preset-submenu"></div>
                        </div>
                        <div class="story-dropdown-active">
                            <div class="story-dropdown-header has-submenu">
                                <span>ğŸ’¾ Save Game</span>
                                <span class="story-dropdown-arrow">â€º</span>
                                <div class="story-save-submenu story-slot-submenu"></div>
                            </div>
                            <div class="story-dropdown-header has-submenu">
                                <span>ğŸ“‚ Load Game</span>
                                <span class="story-dropdown-arrow">â€º</span>
                                <div class="story-load-submenu story-slot-submenu"></div>
                            </div>
                            <hr>
                            <button class="story-dropdown-item" data-action="view">View State</button>
                            <button class="story-dropdown-item" data-action="history">History</button>
                            <button class="story-dropdown-item" data-action="reset">Reset Progress</button>
                            <hr>
                            <button class="story-dropdown-item danger" data-action="disable">Disable Story</button>
                        </div>
                        <div class="story-dropdown-inactive" style="display: none;">
                            <button class="story-dropdown-item" data-action="enable">Enable Story</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="prompt-display"></div>
            <div id="functions-display"></div>
        </div>
        <div id="toast-container"></div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".json" style="display:none">

    <!-- Settings Modal (uses shared modal pattern) -->
    <div id="settings-modal" class="modal-overlay" style="display: none">
        <div class="modal-base">
            <div class="modal-header">
                <h2>Chat Settings</h2>
                <button class="close-btn" id="cancel-settings">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-grid">
                    <!-- Primary Options (always visible) -->
                    <div class="form-group">
                        <label for="setting-prompt">Prompt:</label>
                        <select id="setting-prompt" class="form-control">
                            <option value="sapphire">Sapphire (Default)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-ability">Ability Set:</label>
                        <select id="setting-ability" class="form-control">
                            <option value="default">Default</option>
                            <option value="none">None</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-llm-primary">Provider:</label>
                        <select id="setting-llm-primary" class="form-control">
                            <option value="auto">Auto</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="model-select-group" style="display: none;">
                        <label for="setting-llm-model">Model:</label>
                        <select id="setting-llm-model" class="form-control"></select>
                    </div>
                    
                    <div class="form-group" id="model-custom-group" style="display: none;">
                        <label for="setting-llm-model-custom">Model:</label>
                        <input type="text" id="setting-llm-model-custom" class="form-control" placeholder="Model name">
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-memory-scope">Memory Slot:</label>
                        <div class="memory-scope-row">
                            <select id="setting-memory-scope" class="form-control">
                                <option value="none">None (disabled)</option>
                                <option value="default">default</option>
                            </select>
                            <button type="button" id="new-memory-scope-btn" class="btn btn-small" title="New slot">+</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="setting-trim-color">Accent Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="setting-trim-color" class="form-control color-input" value="#4a9eff">
                            <button type="button" id="reset-trim-color" class="btn btn-small" title="Reset to theme default">Reset</button>
                        </div>
                    </div>
                    
                    <!-- TTS Accordion -->
                    <div class="form-group full-width accordion-section" id="tts-accordion-section">
                        <div class="accordion-header" id="tts-header">
                            <span class="accordion-arrow">â–¶</span>
                            <span>Text-to-Speech</span>
                        </div>
                        <div class="accordion-content" id="tts-content" style="display: none;">
                            <div class="accordion-inner">
                                <div class="form-group">
                                    <label for="setting-voice">Voice:</label>
                                    <select id="setting-voice" class="form-control">
                                        <option value="am_adam">ğŸ‡ºğŸ‡¸ğŸ‘¨ Adam</option>
                                        <option value="am_eric">ğŸ‡ºğŸ‡¸ğŸ‘¨ Eric</option>
                                        <option value="am_liam">ğŸ‡ºğŸ‡¸ğŸ‘¨ Liam</option>
                                        <option value="am_michael">ğŸ‡ºğŸ‡¸ğŸ‘¨ Michael</option>
                                        <option value="af_bella">ğŸ‡ºğŸ‡¸ğŸ‘© Bella</option>
                                        <option value="af_nicole">ğŸ‡ºğŸ‡¸ğŸ‘© Nicole</option>
                                        <option value="af_heart">ğŸ‡ºğŸ‡¸ğŸ‘© Heart</option>
                                        <option value="af_jessica">ğŸ‡ºğŸ‡¸ğŸ‘© Jessica</option>
                                        <option value="af_sarah">ğŸ‡ºğŸ‡¸ğŸ‘© Sarah</option>
                                        <option value="af_river">ğŸ‡ºğŸ‡¸ğŸ‘© River</option>
                                        <option value="af_sky">ğŸ‡ºğŸ‡¸ğŸ‘© Sky</option>
                                        <option value="bf_emma">ğŸ‡¬ğŸ‡§ğŸ‘© Emma</option>
                                        <option value="bf_isabella">ğŸ‡¬ğŸ‡§ğŸ‘© Isabella</option>
                                        <option value="bf_alice">ğŸ‡¬ğŸ‡§ğŸ‘© Alice</option>
                                        <option value="bf_lily">ğŸ‡¬ğŸ‡§ğŸ‘© Lily</option>
                                        <option value="bm_george">ğŸ‡¬ğŸ‡§ğŸ‘¨ George</option>
                                        <option value="bm_daniel">ğŸ‡¬ğŸ‡§ğŸ‘¨ Daniel</option>
                                        <option value="bm_lewis">ğŸ‡¬ğŸ‡§ğŸ‘¨ Lewis</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="setting-pitch">Pitch: <span id="pitch-value">0.94</span></label>
                                    <input type="range" id="setting-pitch" class="form-control" min="0.5" max="1.5" step="0.02" value="0.94">
                                </div>
                                
                                <div class="form-group">
                                    <label for="setting-speed">Speed: <span id="speed-value">1.3</span></label>
                                    <input type="range" id="setting-speed" class="form-control" min="0.5" max="2.5" step="0.1" value="1.3">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Prompt Accordion -->
                    <div class="form-group full-width accordion-section">
                        <div class="accordion-header" id="system-prompt-header">
                            <span class="accordion-arrow">â–¶</span>
                            <span>System Prompt</span>
                        </div>
                        <div class="accordion-content" id="system-prompt-content" style="display: none;">
                            <div class="accordion-inner">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-spice" checked>
                                        Spice every <input type="number" id="setting-spice-turns" min="1" max="20" value="3" style="width: 3em;"> turns
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-datetime">
                                        Inject Date/Time
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label for="setting-custom-context">Custom Context:</label>
                                    <textarea id="setting-custom-context" class="form-control" rows="3" placeholder="Custom text injected into system prompt..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- State Engine Accordion -->
                    <div class="form-group full-width accordion-section">
                        <div class="accordion-header" id="state-engine-header">
                            <span class="accordion-arrow">â–¶</span>
                            <span>State Engine</span>
                            <span class="accordion-badge" id="state-badge" style="display: none;">Active</span>
                        </div>
                        <div class="accordion-content" id="state-engine-content" style="display: none;">
                            <div class="accordion-inner">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="setting-state-enabled">
                                        Enable State Engine
                                    </label>
                                </div>
                                
                                <div class="form-group" id="state-preset-group">
                                    <label for="setting-state-preset">Preset:</label>
                                    <select id="setting-state-preset" class="form-control">
                                        <option value="">None</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label title="Include story/chapter text in prompt. Cache-friendly - only changes on scene advance.">
                                        <input type="checkbox" id="setting-state-story-in-prompt" checked>
                                        Story in prompt
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label title="Include state variables in prompt. âš ï¸ Breaks prompt caching - variables change each turn.">
                                        <input type="checkbox" id="setting-state-vars-in-prompt">
                                        Variables in prompt <span style="opacity:0.6;font-size:0.85em">(no cache)</span>
                                    </label>
                                </div>
                                
                                <div class="state-info" id="state-info" style="display: none;">
                                    <span id="state-turn-info">Turn: 0</span>
                                    <span id="state-key-info">Keys: 0</span>
                                </div>
                                
                                <div class="state-actions" id="state-actions" style="display: none;">
                                    <button type="button" id="state-view-btn" class="btn btn-small">View</button>
                                    <button type="button" id="state-reset-btn" class="btn btn-small">Reset</button>
                                    <button type="button" id="state-history-btn" class="btn btn-small">History</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button id="save-as-defaults" class="btn btn-secondary" title="Save current settings as default for new chats">Set as Default</button>
                <div style="flex: 1;"></div>
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="save-settings" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>


    <template id="message-template">
        <div class="message">
            <img src="" alt="Avatar" class="msg-avatar" loading="lazy">
            <div class="message-wrapper">
                <div class="message-content"></div>
                <div class="toolbar"></div>
            </div>
        </div>
    </template>

    <template id="status-template">
        <div class="message status" id="status-message">
            <img src="/static/users/assistant.webp" alt="Avatar" class="msg-avatar" loading="lazy" onerror="this.style.display='none'">
            <div class="message-content">
                <div class="spinner"></div>
                <span class="status-text">Thinking...</span>
            </div>
        </div>
    </template>

    <!-- Image viewer modal -->
    <div id="image-modal" class="image-modal" style="display: none;">
        <div class="image-modal-backdrop"></div>
        <div class="image-modal-content">
            <img id="image-modal-img" src="" alt="Full size image">
            <button id="image-modal-close" class="image-modal-close">&times;</button>
        </div>
    </div>

    <!-- Script loads sequentially - more reliable than modulepreload with Flask dev server -->
    <!-- Version string (v=) busts cache on updates - increment when deploying JS changes -->
    <script type="module" src="/static/main.js?v=20260204a"></script>
</body>
</html>