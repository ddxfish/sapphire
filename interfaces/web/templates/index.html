<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Sapphire</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/shared.css?v={{ v }}">

    <!-- Syntax Highlighting (local) -->
    <link rel="stylesheet" href="/static/vendor/highlight-atom-one-dark.min.css">
    <script src="/static/vendor/highlight.min.js"></script>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#4a9eff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sapphire">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

    <script>
        // Load saved theme before CSS renders to prevent flash
        (function() {
            const saved = localStorage.getItem('sapphire-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            // Load theme CSS file
            const link = document.createElement('link');
            link.id = 'theme-stylesheet';
            link.rel = 'stylesheet';
            link.href = '/static/themes/' + saved + '.css?v={{ v }}';
            document.head.appendChild(link);
        })();
    </script>
    <script>
        // CSRF protection: inject token into all API fetch requests
        (function() {
            const _fetch = window.fetch;
            window.fetch = function(url, opts) {
                if (typeof url === 'string' && url.startsWith('/api/')) {
                    opts = opts || {};
                    const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
                    if (csrf) opts.headers = { ...opts.headers, 'X-CSRF-Token': csrf };
                }
                return _fetch.apply(this, arguments);
            };
        })();
    </script>
    <link rel="stylesheet" href="/static/style.css?v={{ v }}">
</head>
<body>
    <!-- ================================================================
         NAV RAIL (left, 64px desktop / bottom bar mobile)
         ================================================================ -->
    <nav id="nav-rail">
        <div class="nav-logo" title="Sapphire">S</div>

        <button class="nav-item active" data-view="chat">
            <span class="nav-icon">&#x1F4AC;</span>
            <span class="nav-label">Chat</span>
        </button>
        <button class="nav-item" data-view="prompts">
            <span class="nav-icon">&#x1F464;</span>
            <span class="nav-label">Prompts</span>
        </button>
        <button class="nav-item" data-view="toolsets">
            <span class="nav-icon">&#x1F527;</span>
            <span class="nav-label">Toolsets</span>
        </button>
        <button class="nav-item" data-view="spices">
            <span class="nav-icon">&#x1F336;&#xFE0F;</span>
            <span class="nav-label">Spices</span>
        </button>
        <button class="nav-item" data-view="schedule">
            <span class="nav-icon">&#x23F0;</span>
            <span class="nav-label">Schedule</span>
        </button>
        <button class="nav-item" data-view="mind">
            <span class="nav-icon">&#x1F9E0;</span>
            <span class="nav-label">Mind</span>
        </button>
        <button class="nav-item" data-view="settings">
            <span class="nav-icon">&#x2699;&#xFE0F;</span>
            <span class="nav-label">Settings</span>
        </button>

        <div class="nav-spacer"></div>

        <!-- Mobile overflow (6th+ items) -->
        <button class="nav-item nav-overflow" style="display:none" title="More">
            <span class="nav-icon">&#x2026;</span>
            <span class="nav-label">More</span>
        </button>
        <div class="nav-overflow-menu hidden"></div>

        <span class="nav-version">v2</span>
    </nav>

    <!-- ================================================================
         APP CONTENT (all views live here)
         ================================================================ -->
    <div id="app-content">

        <!-- ============================================================
             CHAT VIEW
             ============================================================ -->
        <div id="view-chat" class="view active">
            <!-- Chat Content + Settings Sidebar -->
            <div class="chat-body">
                <!-- Messages area -->
                <div class="chat-main">
                    <div id="chatbg">
                        <div id="chatbg-overlay">
                            <div id="chat-container"></div>
                        </div>
                    </div>
                    <div class="form-wrapper">
                        <div id="context-bar"></div>
                        <div id="image-preview-area" style="display: none;"></div>
                        <form id="chat-form">
                            <div class="volume-compact" id="volume-compact">
                                <button type="button" id="mute-btn" class="vol-btn" title="Volume">&#x1F50A;</button>
                                <div class="volume-popover" id="volume-popover">
                                    <input type="range" id="volume-slider" min="0" max="100" value="100" title="Volume">
                                </div>
                            </div>
                            <button type="button" id="mic-btn" title="Hold to record">&#x1F3A4;</button>
                            <div class="textarea-wrapper">
                                <button type="button" id="image-upload-btn" title="Attach image (or paste/drop)">&#x1F4CE;</button>
                                <textarea id="prompt-input" placeholder="Type message... (paste or drop images)" rows="1"></textarea>
                            </div>
                            <input type="file" id="image-upload-input" accept="image/*,.py,.txt,.md,.js,.ts,.json,.yaml,.yml,.toml,.ini,.cfg,.conf,.sh,.bash,.html,.css,.xml,.csv,.log,.env,.rs,.go,.java,.c,.cpp,.h" multiple style="display: none;">
                            <div class="send-btn-wrapper">
                                <button type="submit" id="send-btn">Send</button>
                                <button type="button" id="stop-btn" style="display: none;">Stop</button>
                                <span id="llm-indicator"></span>
                            </div>
                        </form>
                        <div id="prompt-display"></div>
                        <div id="functions-display"></div>
                    </div>
                </div>

                <!-- Chat Settings Sidebar (right) -->
                <aside class="chat-sidebar">
                    <div class="chat-sidebar-inner">
                        <!-- Row 1: accent circle + chat name + collapse -->
                        <div class="sb-chat-header">
                            <input type="color" id="sb-trim-color" value="#4a9eff" class="sb-accent-circle" title="Accent color (double-click to reset)">
                            <div class="sb-chat-picker" id="sb-chat-picker">
                                <button class="sb-chat-picker-btn" id="sb-chat-picker-btn">
                                    <span id="sb-chat-name">Chat</span>
                                    <span class="sb-chat-arrow">&#x25BE;</span>
                                </button>
                                <div class="sb-chat-picker-dropdown" id="sb-chat-picker-dropdown"></div>
                            </div>
                            <button type="button" id="chat-sidebar-toggle" class="sb-icon-btn sb-collapse-btn" title="Hide sidebar">&#x25B6;</button>
                        </div>
                        <!-- Row 2: chat actions -->
                        <div class="sb-chat-actions">
                            <button type="button" id="sb-new-chat" class="sb-icon-btn" title="New Chat">+</button>
                            <button type="button" id="sb-delete-chat" class="sb-icon-btn sb-icon-danger" title="Delete Chat">&#x1F5D1;</button>
                            <button type="button" id="clear-chat-btn" class="sb-icon-btn" title="Clear Chat">&#x2715;</button>
                            <div class="sb-kebab kebab-menu" id="chat-menu">
                                <button type="button" class="sb-icon-btn kebab-btn" title="More">&#x22EE;</button>
                                <div class="kebab-dropdown">
                                    <button id="import-chat-btn">Import</button>
                                    <button id="export-chat-btn">Export</button>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <div class="sb-field">
                                <label for="sb-prompt">prompt</label>
                                <div class="sb-field-row">
                                    <select id="sb-prompt"><option value="sapphire">Sapphire</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-view" data-view="prompts" data-select="sb-prompt" title="Open in Prompts">&#x2197;</button>
                                </div>
                            </div>
                            <div class="sb-field">
                                <label for="sb-toolset">toolset</label>
                                <div class="sb-field-row">
                                    <select id="sb-toolset"><option value="all">All</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-view" data-view="toolsets" data-select="sb-toolset" title="Open in Toolsets">&#x2197;</button>
                                </div>
                            </div>
                            <div class="sb-field">
                                <label for="sb-llm-primary">provider</label>
                                <select id="sb-llm-primary"><option value="auto">Auto</option></select>
                            </div>
                            <div class="sb-field" id="sb-model-group" style="display:none">
                                <label for="sb-llm-model">model</label>
                                <select id="sb-llm-model"></select>
                            </div>
                            <div class="sb-field" id="sb-model-custom-group" style="display:none">
                                <label for="sb-llm-model-custom">model</label>
                                <input type="text" id="sb-llm-model-custom" placeholder="Model name">
                            </div>
                        </div>

                        <!-- Quick toggles -->
                        <div class="sb-toggles">
                            <button type="button" class="sb-toggle active" id="sb-spice-toggle" data-active="true">Spice &middot; 3</button>
                            <button type="button" class="sb-toggle" id="sb-datetime-toggle" data-active="false">Date/Time</button>
                        </div>

                        <!-- Mind Scopes Accordion -->
                        <div class="sidebar-section sidebar-accordion">
                            <div class="sidebar-accordion-header">
                                <span class="accordion-arrow">&#x25B6;</span>
                                <span>&#x1F9E0; Mind</span>
                            </div>
                            <div class="sidebar-accordion-content" style="display:none">
                            <div class="sb-field">
                                <label for="sb-memory-scope">memory</label>
                                <div class="sb-field-row">
                                    <select id="sb-memory-scope"><option value="none">None</option><option value="default">default</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-mind" data-tab="memories" title="Open in Mind">&#x2197;</button>
                                </div>
                            </div>
                            <div class="sb-field">
                                <label for="sb-goal-scope">goals</label>
                                <div class="sb-field-row">
                                    <select id="sb-goal-scope"><option value="none">None</option><option value="default">default</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-mind" data-tab="goals" title="Open in Mind">&#x2197;</button>
                                </div>
                            </div>
                            <div class="sb-field">
                                <label for="sb-knowledge-scope">knowl.</label>
                                <div class="sb-field-row">
                                    <select id="sb-knowledge-scope"><option value="none">None</option><option value="default">default</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-mind" data-tab="knowledge" title="Open in Mind">&#x2197;</button>
                                </div>
                            </div>
                            <div class="sb-field">
                                <label for="sb-people-scope">people</label>
                                <div class="sb-field-row">
                                    <select id="sb-people-scope"><option value="none">None</option><option value="default">default</option></select>
                                    <button type="button" class="sb-btn-sm sb-goto-mind" data-tab="people" title="Open in Mind">&#x2197;</button>
                                </div>
                            </div>
                            </div>
                        </div>

                        <!-- TTS (Voice) Accordion -->
                        <div class="sidebar-section sidebar-accordion">
                            <div class="sidebar-accordion-header">
                                <span class="accordion-arrow">&#x25B6;</span>
                                <span>TTS (Voice)</span>
                            </div>
                            <div class="sidebar-accordion-content" style="display:none">
                                <div class="sb-field">
                                    <label for="sb-voice">voice</label>
                                    <select id="sb-voice">
                                        <option value="am_adam">&#x1F1FA;&#x1F1F8;&#x1F468; Adam</option>
                                        <option value="am_eric">&#x1F1FA;&#x1F1F8;&#x1F468; Eric</option>
                                        <option value="am_liam">&#x1F1FA;&#x1F1F8;&#x1F468; Liam</option>
                                        <option value="am_michael">&#x1F1FA;&#x1F1F8;&#x1F468; Michael</option>
                                        <option value="af_bella">&#x1F1FA;&#x1F1F8;&#x1F469; Bella</option>
                                        <option value="af_nicole">&#x1F1FA;&#x1F1F8;&#x1F469; Nicole</option>
                                        <option value="af_heart">&#x1F1FA;&#x1F1F8;&#x1F469; Heart</option>
                                        <option value="af_jessica">&#x1F1FA;&#x1F1F8;&#x1F469; Jessica</option>
                                        <option value="af_sarah">&#x1F1FA;&#x1F1F8;&#x1F469; Sarah</option>
                                        <option value="af_river">&#x1F1FA;&#x1F1F8;&#x1F469; River</option>
                                        <option value="af_sky">&#x1F1FA;&#x1F1F8;&#x1F469; Sky</option>
                                        <option value="bf_emma">&#x1F1EC;&#x1F1E7;&#x1F469; Emma</option>
                                        <option value="bf_isabella">&#x1F1EC;&#x1F1E7;&#x1F469; Isabella</option>
                                        <option value="bf_alice">&#x1F1EC;&#x1F1E7;&#x1F469; Alice</option>
                                        <option value="bf_lily">&#x1F1EC;&#x1F1E7;&#x1F469; Lily</option>
                                        <option value="bm_george">&#x1F1EC;&#x1F1E7;&#x1F468; George</option>
                                        <option value="bm_daniel">&#x1F1EC;&#x1F1E7;&#x1F468; Daniel</option>
                                        <option value="bm_lewis">&#x1F1EC;&#x1F1E7;&#x1F468; Lewis</option>
                                    </select>
                                </div>
                                <div class="sb-field sb-field-stack">
                                    <label>Pitch: <span id="sb-pitch-val">0.94</span></label>
                                    <input type="range" id="sb-pitch" min="0.5" max="1.5" step="0.02" value="0.94">
                                </div>
                                <div class="sb-field sb-field-stack">
                                    <label>Speed: <span id="sb-speed-val">1.3</span></label>
                                    <input type="range" id="sb-speed" min="0.5" max="2.5" step="0.1" value="1.3">
                                </div>
                            </div>
                        </div>

                        <!-- System Prompt Accordion -->
                        <div class="sidebar-section sidebar-accordion">
                            <div class="sidebar-accordion-header">
                                <span class="accordion-arrow">&#x25B6;</span>
                                <span>System Prompt</span>
                            </div>
                            <div class="sidebar-accordion-content" style="display:none">
                                <div class="sb-field">
                                    <label for="sb-spice-turns">spice turns</label>
                                    <input type="number" id="sb-spice-turns" min="1" max="20" value="3">
                                </div>
                                <div class="sb-field sb-field-stack">
                                    <label for="sb-custom-context">Custom Context</label>
                                    <textarea id="sb-custom-context" rows="3" placeholder="Injected into system prompt..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- State Engine Accordion -->
                        <div class="sidebar-section sidebar-accordion">
                            <div class="sidebar-accordion-header">
                                <span class="accordion-arrow">&#x25B6;</span>
                                <span>State Engine</span>
                            </div>
                            <div class="sidebar-accordion-content" style="display:none">
                                <div class="sb-field">
                                    <label><input type="checkbox" id="sb-state-enabled"> Enable</label>
                                </div>
                                <div class="sb-field">
                                    <label for="sb-state-preset">preset</label>
                                    <select id="sb-state-preset"><option value="">None</option></select>
                                </div>
                                <div class="sb-field">
                                    <label><input type="checkbox" id="sb-state-story" checked> Story in prompt</label>
                                </div>
                                <div class="sb-field">
                                    <label><input type="checkbox" id="sb-state-vars"> Variables in prompt</label>
                                </div>
                                <div class="sb-field sb-actions">
                                    <button type="button" id="sb-state-view" class="sb-btn-sm">View</button>
                                    <button type="button" id="sb-state-reset" class="sb-btn-sm">Reset</button>
                                </div>
                            </div>
                        </div>

                        <!-- Save as Defaults -->
                        <div class="sidebar-section sb-footer">
                            <button type="button" id="sb-save-defaults" class="sb-btn-full">Save as Defaults</button>
                        </div>
                    </div>
                </aside>
                <!-- Sidebar expand tab (visible when collapsed) -->
                <button type="button" id="chat-sidebar-expand" class="sb-expand-tab" title="Show settings">&#x25C0;</button>
            </div>

            <div id="toast-container"></div>
        </div>

        <!-- ============================================================
             PLACEHOLDER VIEWS (content in later steps)
             ============================================================ -->
        <div id="view-prompts" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Prompts</h2>
                <p>Prompt editor - coming next</p>
            </div>
        </div>
        <div id="view-toolsets" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Toolsets</h2>
                <p>Ability manager - coming next</p>
            </div>
        </div>
        <div id="view-spices" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Spices</h2>
                <p>Spice manager - coming next</p>
            </div>
        </div>
        <div id="view-schedule" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Schedule</h2>
                <p>Continuity manager - coming next</p>
            </div>
        </div>
        <div id="view-mind" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Mind</h2>
                <p>Knowledge base - loading...</p>
            </div>
        </div>
        <div id="view-settings" class="view" style="display:none">
            <div class="view-placeholder">
                <h2>Settings</h2>
                <p>System settings - coming next</p>
            </div>
        </div>
    </div>

    <!-- Hidden elements kept for compatibility -->
    <select id="chat-select" style="display:none"><option value="default">Default</option></select>
    <input type="file" id="import-file-input" accept=".json" style="display:none">

    <!-- Templates -->
    <template id="message-template">
        <div class="message">
            <img src="" alt="Avatar" class="msg-avatar" loading="lazy">
            <div class="message-wrapper">
                <div class="message-content"></div>
                <div class="toolbar"></div>
            </div>
        </div>
    </template>

    <template id="status-template">
        <div class="message status" id="status-message">
            <img src="/static/users/assistant.webp" alt="Avatar" class="msg-avatar" loading="lazy" onerror="this.style.display='none'">
            <div class="message-content">
                <div class="spinner"></div>
                <span class="status-text">Thinking...</span>
            </div>
        </div>
    </template>

    <!-- Image viewer modal -->
    <div id="image-modal" class="image-modal" style="display: none;">
        <div class="image-modal-backdrop"></div>
        <div class="image-modal-content">
            <img id="image-modal-img" src="" alt="Full size image">
            <button id="image-modal-close" class="image-modal-close">&times;</button>
            <button id="image-modal-prev" class="image-modal-nav image-modal-prev-btn">&#8249;</button>
            <button id="image-modal-next" class="image-modal-nav image-modal-next-btn">&#8250;</button>
            <div id="image-modal-counter" class="image-modal-counter"></div>
        </div>
    </div>

    <script>
        window.__v='{{ v }}';
        // Unregister any stale service workers (PWA manifest can trigger phantom caching)
        if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(sw => sw.unregister()));
    </script>
    <script type="importmap">{{ import_map | safe }}</script>
    <script type="module" src="/static/main.js?v={{ v }}"></script>
</body>
</html>
